<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Scanner - Plant Doctor</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Epilogue:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <style type="text/tailwindcss">
        @theme {
            --color-primary: #3a6960;
            --color-deep-moss: #3a6960;
            --color-snow-blossom: #fdfcfc;
            --color-soil-grey: #64748b;
            --color-sunlight-glow: #F59E0B;
            --color-accent-pink: #D7A3A6;
            --color-bark-brown: #433422;
            --color-background-light: #fdfcfc;
            --color-background-dark: #18302d;
            --color-surface-dark: #2B443F;

            --font-display: "Epilogue", sans-serif;

            --radius-DEFAULT: 0.5rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --radius-full: 9999px;
        }
        @custom-variant dark (&:where(.dark, .dark *));
    </style>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        body { font-family: 'Epilogue', sans-serif; }
    </style>
</head>
<body class="bg-black h-screen overflow-hidden font-display">
    <div class="relative w-full h-full flex flex-col">
        
        <!-- Live Camera Feed -->
        <div class="absolute inset-0 z-0 bg-black">
             <video id="camera-feed" autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
             <canvas id="capture-canvas" class="hidden"></canvas>
             <!-- Fallback/Permission Message -->
             <div id="camera-error" class="hidden absolute inset-0 flex items-center justify-center bg-black/80 p-8 text-center">
                 <p class="text-white text-sm">Camera access is required. Please check your browser permissions or use the upload button.</p>
             </div>
        </div>

        <!-- Top Bar -->
        <div class="relative z-10 w-full p-6 flex justify-between items-start pt-10 bg-gradient-to-b from-black/60 to-transparent">
             <a href="{% url 'diagnose:dashboard' %}" class="w-10 h-10 rounded-full bg-black/20 backdrop-blur-md flex items-center justify-center text-white hover:bg-black/40 transition-all">
               <span class="material-symbols-outlined text-xl">arrow_back</span>
             </a>
             <div class="bg-black/40 backdrop-blur-sm px-4 py-1 rounded-full border border-white/10">
                 <p class="text-white text-xs font-bold tracking-wider uppercase">Live</p>
             </div>
             <a href="{% url 'core:features' %}" class="w-10 h-10 rounded-full bg-black/20 backdrop-blur-md flex items-center justify-center text-white hover:bg-black/40 transition-all" title="Help">
               <span class="material-symbols-outlined text-xl">help</span>
             </a>
        </div>

        <!-- Viewfinder Overlay -->
        <div class="flex-1 relative z-10 flex items-center justify-center pointer-events-none">
            <div class="w-72 h-72 border border-white/20 rounded-[2rem] relative shadow-[0_0_0_9999px_rgba(0,0,0,0.3)]">
                <!-- Corners -->
                <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-2xl"></div>
                <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-2xl"></div>
                <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-2xl"></div>
                <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-2xl"></div>
                
                <!-- Guidance Text -->
                <p class="absolute -top-12 w-full text-center text-white font-bold text-sm tracking-widest drop-shadow-md">ALIGN LEAF HERE</p>
            </div>
        </div>

        <!-- Bottom Controls -->
        <form id="upload-form" method="post" enctype="multipart/form-data" class="relative z-20 w-full p-8 pb-12 flex items-center justify-between bg-gradient-to-t from-black/90 via-black/50 to-transparent">
            {% csrf_token %}
            <!-- Hidden input for file upload (gallery or capture) -->
            <input type="file" name="image" id="image-input" accept="image/*" class="hidden">
            
            <!-- Gallery / Upload -->
            <button type="button" onclick="document.getElementById('image-input').click()" class="w-14 h-14 rounded-2xl bg-white/10 backdrop-blur-md border border-white/10 flex items-center justify-center text-white hover:bg-white/20 transition-all active:scale-95">
               <span class="material-symbols-outlined text-2xl">photo_library</span>
            </button>
    
            <!-- Shutter -->
            <button type="button" id="shutter-btn" class="w-24 h-24 rounded-full border-4 border-white/80 flex items-center justify-center group active:scale-90 transition-all shadow-lg shadow-black/50">
               <div class="w-20 h-20 rounded-full bg-white group-hover:scale-90 transition-all duration-200"></div>
            </button>
    
            <!-- Flash (Toggle logic omitted for simplicity) -->
             <button type="button" class="w-14 h-14 rounded-2xl bg-white/10 backdrop-blur-md border border-white/10 flex items-center justify-center text-white hover:bg-white/20 transition-all active:scale-95">
               <span class="material-symbols-outlined text-2xl">flash_off</span>
            </button>
        </form>
    </div>

    <script>
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('capture-canvas');
        const shutterBtn = document.getElementById('shutter-btn');
        const imageInput = document.getElementById('image-input');
        const form = document.getElementById('upload-form');
        const errorMsg = document.getElementById('camera-error');

        // Initialize Camera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Prefer back camera on mobile
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera access denied:", err);
                errorMsg.classList.remove('hidden');
            }
        }

        // Capture Photo
        shutterBtn.addEventListener('click', () => {
            if (video.srcObject) {
                // Capture from video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                
                // Draw current frame
                // Note: If using front camera and mirrored CSS, we might need to flip canvas too, 
                // but 'environment' mode usually doesn't need mirroring logic in the file itself.
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert to blob and submit
                canvas.toBlob((blob) => {
                    const file = new File([blob], "capture.jpg", { type: "image/jpeg" });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    imageInput.files = dataTransfer.files;
                    
                    // Stop stream before submitting
                    video.srcObject.getTracks().forEach(track => track.stop());
                    
                    form.submit();
                }, 'image/jpeg', 0.9);
            } else {
                // Fallback: Trigger file input if no camera
                imageInput.click();
            }
        });

        // Handle Gallery Selection
        imageInput.addEventListener('change', () => {
            if (imageInput.files.length > 0) {
                form.submit();
            }
        });

        // Start camera on load
        window.addEventListener('load', initCamera);
    </script>
