{% extends 'base/base.html' %}
{% load static %}

{% block title %}My Profile - Plant Doctor{% endblock %}

{% block content %}
<!-- Main Content -->
<div class="flex-1 px-6 pb-24 flex flex-col items-center mt-8">
    
    <!-- Form -->
    <form id="profile-form" method="post" enctype="multipart/form-data" class="w-full max-w-md flex flex-col gap-5 items-center">
        {% csrf_token %}

        <!-- Profile Picture (Moved inside form for better structure, though not strictly necessary if input is here) -->
        <div class="relative mb-4">
            <div class="w-32 h-32 rounded-full bg-deep-moss/10 flex items-center justify-center border-4 border-white shadow-xl text-deep-moss overflow-hidden relative">
                {% if user.avatar %}
                    <img id="avatar-preview" src="{{ user.avatar.url }}" class="w-full h-full object-cover" />
                {% else %}
                    <img id="avatar-preview" class="hidden w-full h-full object-cover" />
                    <span class="material-symbols-outlined text-6xl" id="profile-icon">person</span>
                {% endif %}
            </div>
            
            <!-- File Input -->
            <input type="file" name="avatar" id="id_avatar" class="hidden" accept="image/*" disabled>
            
            <button type="button" id="avatar-btn" class="absolute bottom-0 right-0 w-10 h-10 bg-sunlight-glow rounded-full flex items-center justify-center text-deep-moss shadow-lg border-2 border-white hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="material-symbols-outlined text-xl">photo_camera</span>
            </button>
        </div>

        <div class="w-full">
            <label class="block text-sm font-bold text-deep-moss mb-2 ml-1" for="id_full_name">Full Name</label>
            <input type="text" name="full_name" id="id_full_name" value="{{ user.full_name }}" disabled
                class="w-full px-5 py-4 rounded-xl border-2 border-slate-100 bg-slate-50 text-soil-grey font-medium outline-none transition-all
                       disabled:bg-slate-50 disabled:text-soil-grey disabled:border-transparent
                       enabled:bg-white enabled:text-deep-moss enabled:border-deep-moss/20 enabled:focus:border-deep-moss enabled:focus:ring-4 enabled:focus:ring-deep-moss/10">
        </div>

        <div class="w-full">
            <label class="block text-sm font-bold text-deep-moss mb-2 ml-1" for="id_email">Email Address</label>
            <input type="email" id="id_email" value="{{ user.email }}" disabled
                class="w-full px-5 py-4 rounded-xl border-2 border-slate-100 bg-slate-50 text-soil-grey font-medium outline-none transition-all
                       disabled:bg-slate-50 disabled:text-soil-grey disabled:border-transparent">
        </div>

        <div class="w-full">
            <label class="block text-sm font-bold text-deep-moss mb-2 ml-1" for="id_location">Location</label>
            <input type="text" name="location" id="id_location" value="{{ user.location }}" disabled
                class="w-full px-5 py-4 rounded-xl border-2 border-slate-100 bg-slate-50 text-soil-grey font-medium outline-none transition-all
                       disabled:bg-slate-50 disabled:text-soil-grey disabled:border-transparent
                       enabled:bg-white enabled:text-deep-moss enabled:border-deep-moss/20 enabled:focus:border-deep-moss enabled:focus:ring-4 enabled:focus:ring-deep-moss/10">
        </div>

        <div id="save-container" class="hidden">
            <button type="submit" class="w-full py-4 rounded-xl bg-sunlight-glow text-deep-moss font-bold text-lg shadow-lg shadow-sunlight-glow/20 hover:bg-sunlight-glow/90 transition-all active:scale-95">
                Save Changes
            </button>
        </div>
    </form>

    <div class="w-full max-w-md mt-6">
        <a href="{% url 'users:logout' %}" class="w-full flex items-center justify-center gap-2 py-4 rounded-xl border-2 border-red-100 bg-red-50 text-red-500 font-bold text-lg hover:bg-red-100 hover:border-red-200 transition-all active:scale-95">
            <span class="material-symbols-outlined">logout</span>
            Logout
        </a>
    </div>

</div>

<!-- Bottom Action Bar -->
<div class="fixed bottom-0 left-0 right-0 p-6 bg-white border-t border-slate-100 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
    <button id="edit-btn" class="w-full py-4 rounded-xl bg-deep-moss text-white font-bold text-lg shadow-lg shadow-deep-moss/20 hover:bg-deep-moss/90 transition-all active:scale-95">
        Edit Profile
    </button>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const editBtn = document.getElementById('edit-btn');
    const saveContainer = document.getElementById('save-container');
    const formInputs = document.querySelectorAll('#profile-form input:not([type="hidden"]):not([id="id_email"])');
    const avatarBtn = document.getElementById('avatar-btn');
    const avatarInput = document.getElementById('id_avatar');
    const avatarPreview = document.getElementById('avatar-preview');
    const profileIcon = document.getElementById('profile-icon');
    let isEditing = false;

    editBtn.addEventListener('click', () => {
        isEditing = !isEditing;

        if (isEditing) {
            // Switch to Edit Mode
            formInputs.forEach(input => input.disabled = false);
            avatarBtn.disabled = false;
            formInputs[0].focus(); // Focus name
            editBtn.classList.add('hidden');
            saveContainer.classList.remove('hidden');
        }
    });

    // Avatar Upload Logic
    avatarBtn.addEventListener('click', () => {
        avatarInput.click();
    });

    avatarInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarPreview.src = e.target.result;
                avatarPreview.classList.remove('hidden');
                if (profileIcon) profileIcon.classList.add('hidden');
            }
            reader.readAsDataURL(file);
        }
    });
</script>
{% endblock %}
